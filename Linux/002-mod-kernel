#!/bin/bash
set -euo pipefail

# Verificamos que sea root
if [[ $EUID -ne 0 ]]; then
    echo "\nüîí Este script debe ejecutarse como root (us√° sudo)\n"
    exit 1
fi

echo "\nüì¶ Listando m√≥dulos del kernel activos... \n"
echo

# Obtener m√≥dulos con sus nombres y versiones (si se pueden identificar)
mapfile -t modules < <(lsmod | awk 'NR>1 {print $1, $3}' | nl -w2 -s'. ')

if [ ${#modules[@]} -eq 0 ]; then
    echo "\n ‚úÖ No hay m√≥dulos activos (muy raro) \n"
    exit 0
fi

# Mostrar lista numerada
for mod in "${modules[@]}"; do
    echo "$mod"
done

echo
read -rp "üëâ Ingres√° el n√∫mero del m√≥dulo que quer√©s desactivar o eliminar: " index

# Verificamos √≠ndice
if ! [[ "$index" =~ ^[0-9]+$ ]] || (( index < 1 || index > ${#modules[@]} )); then
    echo "\n‚ùå N√∫mero inv√°lido\n"
    exit 1
fi

# Obtener nombre del m√≥dulo
mod_line="${modules[$((index-1))]}"
mod_name=$(echo "$mod_line" | awk '{print $2}')  # porque tiene n√∫mero delante

echo -e "\n‚ö†Ô∏è Est√°s por intentar desactivar o eliminar el m√≥dulo: \e[1m$mod_name\e[0m"
read -rp "\nüîê Por seguridad, escrib√≠ el nombre exacto del m√≥dulo para confirmar: " confirm

if [[ "$confirm" != "$mod_name" ]]; then
    echo "\n‚ùå Nombre incorrecto. Cancelando."
    exit 1
fi

# Intentamos eliminarlo
echo "\nüöß Desactivando m√≥dulo..."
if modprobe -r "$mod_name" 2>/dev/null; then
    echo "\n‚úÖ M√≥dulo '$mod_name' desactivado correctamente con modprobe -r"
elif rmmod "$mod_name" 2>/dev/null; then
    echo "\n‚úÖ M√≥dulo '$mod_name' removido con rmmod"
else
    echo "\n‚ùå Error al remover el m√≥dulo. Puede estar en uso o ser cr√≠tico del sistema."
    exit 1
fi
