#!/bin/bash

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“„ DocumentaciÃ³n 003-filesystems-disable
# Este script permite:
#   - Listar los sistemas de archivos cargados en el kernel (de /proc/filesystems)
#   - Mostrar una lista numerada y ordenada alfabÃ©ticamente
#   - Seleccionar uno para desactivar (modprobe -r)
#   - Confirmar antes de eliminarlo
# Uso: sudo ./filesystems-disable.sh
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

set -euo pipefail

echo -e "\nğŸ§¾ Este script permite listar y desactivar sistemas de archivos soportados por el kernel."
echo "PodÃ©s usarlo para deshabilitar mÃ³dulos como cramfs, udf, squashfs, etc."
echo -e "PresionÃ¡ ENTER para continuar..."
read -r

# Verificar permisos
if [[ $EUID -ne 0 ]]; then
    echo -e "\nğŸ”’ Este script debe ejecutarse como root (usÃ¡ sudo)\n"
    exit 1
fi

echo -e "\nğŸ“‚ Listando sistemas de archivos cargados..."

# Obtener lista Ãºnica de sistemas de archivos (ignorando los "nodev") y ordenarlos
mapfile -t fs_modules < <(grep -v 'nodev' /proc/filesystems | awk '{print $1}' | sort | nl -w2 -s'. ')

if [ ${#fs_modules[@]} -eq 0 ]; then
    echo -e "\nâœ… No se encontraron sistemas de archivos cargados para desactivar\n"
    exit 0
fi

# Mostrar lista
for fs in "${fs_modules[@]}"; do
    echo "$fs"
done

echo
read -rp "ğŸ‘‰ IngresÃ¡ el nÃºmero del sistema de archivos que querÃ©s desactivar: " index

if ! [[ "$index" =~ ^[0-9]+$ ]] || (( index < 1 || index > ${#fs_modules[@]} )); then
    echo -e "\nâŒ NÃºmero invÃ¡lido\n"
    exit 1
fi

fs_line="${fs_modules[$((index-1))]}"
fs_name=$(echo "$fs_line" | awk '{print $2}')

echo -e "\nâš ï¸ EstÃ¡s por intentar desactivar el sistema de archivos: \e[1m$fs_name\e[0m"
read -rp "ğŸ” Por seguridad, escribÃ­ el nombre exacto para confirmar: " confirm

if [[ "$confirm" != "$fs_name" ]]; then
    echo -e "\nâŒ Nombre incorrecto. Cancelando."
    exit 1
fi

echo -e "\nğŸš§ Desactivando mÃ³dulo asociado al sistema de archivos '$fs_name'..."

# Intentamos remover el mÃ³dulo
if modprobe -r "$fs_name" 2>/dev/null; then
    echo -e "\nâœ… MÃ³dulo del sistema de archivos '$fs_name' desactivado correctamente con modprobe -r"
elif rmmod "$fs_name" 2>/dev/null; then
    echo -e "\nâœ… MÃ³dulo '$fs_name' removido con rmmod"
else
    echo -e "\nâŒ No se pudo remover el mÃ³dulo. Puede no estar cargado, no tener mÃ³dulo o estar en uso."
    exit 1
fi
